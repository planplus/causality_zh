---
title: 数据与同步
date: 2021-07-21 23:10:30
---
## 为什么不能同步了？iCloud 可能卡住了。
Metion 默认的工作目录是基于 iCloud Drive (iCloud 云盘) 同步的，Metion 会把文档同时存储一份到 iCloud Drive 上，之后就完全由操作系统自己处理，Metion 本身并不参与同步。
**如果 iCloud 的同步卡住了、出现问题了，那么 Metion 也将无法同步。**

## 怎么判断当前 iCloud 是否卡住了？
Mac 端的 Finder 左侧栏，如果看到 iCloud 云盘的位置(长时间)有**灰色圆点(或扇形)** ，那么 iCloud 的同步就是卡住了。如果是 iOS、iPadOS，通过系统内置的 Files(文件) 进入到 iCloud 云盘的 Metion 目录，查看未能同步到其它设备的文档、文件夹，如果看到很多 **pending、等待上传**的标识，说明 iCloud 的同步也卡住了。实际使用经验来看，macOS 的 iCloud 似乎出问题的概率会比 iOS 上高一些。
我们也可以独立地、完全脱离 Metion 来通过 iCloud Drive 同步一些文件，简单地判断当前 iCloud Drive 是否卡主了。

## iCloud 的同步卡住了，有什么办法？
因为操作系统带来的问题，没有实际有效的解决办法。
**只能等** iCloud 自己恢复工作，有时候，**重启设备**，也会有助于 iCloud 恢复工作。iCloud 在不遇到问题时，是非常不错的，但是遇到问题之后，它自己如何恢复同步，也蛮玄学的，可能除了**等待**别无二法。

## iCloud 和 Git 怎么选择？
佛系一点，使用 iCloud 进行同步，是非常方便的，因为多数时候，它的同步是没有问题的。同步有问题，等等就好了。
如果希望更可控的同步方式，并且知道如何使用 Git 的话，可以在 Metion 内新建一个 Git 性质的工作目录，并使用 Git 来进行同步，它定然是更稳定的，而且功能超级强大。但如果不知道 Git 是什么，这里会存在学习成本，希望理解。

## 三种性质的工作目录
### 默认方式 (iCloud 云盘)
这是 Metion 默认的工作目录类型，数据在当前设备存储一份的同时，另一份会存储在对应`iCloud 云盘`的位置上以实现同步的机制。

系统的`iCloud 云盘`会处理所有同步逻辑，它完全是操作系统（iOS/iPadOS/macOS) 控制的。
多数时候，它应该是稳定和快速的，但也有可能发生同步慢、不完全、冲突覆盖与重复，甚至不同步的情况。如果`同步`完全无法工作，可能需要重启设备并非常耐心地等待 iCloud 恢复正常的同步工作。

另外，因为 Metion 此时采用双向存储的逻辑，即本地设备存储一份、iCloud云盘 存储一份，文档、文件夹的删除、改名、移动的操作信息也需要通过 iCloud云盘 同步，如果这部分信息同步不及时，Metion 为了保证数据存储的尽可能可靠性，可能会出现原路径的文档、文件夹仍然存在的情况(双向互为备份产生的复制)。

**注意:** 一般情况下，没有必要在系统设置里禁用`iCloud云盘`，或者禁用之后再启用。一些涉及到 iCloud 数据潜在丢失风险的操作中，操作系统也会有非常明确的说明，但可能对很多普通用户来说，不太能理解警告的具体含义就直接点了`确定`，之后数据就彻底丢失了。**所以，请一定要相信操作系统提供的警告，它说数据会丢失，就一定会丢失！**

### Git 工作目录
Git 非常强大，将它作为跨设备同步的工具，只是其中一个非常小的应用。为了让 Metion 的使用者能可靠地存储、同步数据，我们做了很多努力，将 Git 内嵌到了 Metion 当中，不但是 macOS，iOS 和 iPadOS 上也能工作。

如果需要使用基于 Git 的工作目录：首先，需要了解 Git 的基本用法；其次，需要有 Git 的服务端托管，比如 Github、Gitee 或者自己部署的 Git 服务。
Metion 已经针对 Git 实现了一些自动的机制，包括自动提交、同步逻辑、版本冲突的合并，但如果有更专业的要求(比如有多人协作、共同提交的场景)，也可以考虑使用第三方的 Git 软件进行管理。

**注意:**  Git 性质的工作目录的同步，需要自己手工操作，另外，它也不会同步到 iCloud 云盘中，所以，请及时 push 到 remote repo 上，避免数据丢失的可能。

### 外部工作目录
可以挂载其它位置的文件夹作为 Metion 的工作目录，它可以是某个第三方 App 管理的文件夹，也可以是其它非 Metion 相关位于 iCloud Drive 上的文件夹。

#### 可以使用 Dropbox、Google Drive 上的目录吗？
如果是 Mac 上，基本上可以使用任何第三方云盘相关文件夹。
但很遗憾，在 iOS 上，目前 Dropbox、Google Drive 似乎尚未完全支持这种完全开放的文件夹机制，如果将来它们也支持了，也是可以进行同样的操作。

#### 外部工作目录的局限
有些 Metion 的功能，在外部工作目录中会失效，比如下面的功能：
1. 最近文档历史的备份，但单篇文档的历史版本是生效的；
2. 最近打开文档的列表查询；
3. 回收站的功能，但可能会进入 iOS 系统自身的回收站，Metion 不具备读取的权限。


## 找回数据
有两个简单的方法可以先尝试找回历史版本： 1. 文档列表中的某篇文章右键点击或者向左滑动可以看到**历史版本**的入口；2. 右上角的右侧第二个按钮的子菜单下有**最近文档的历史版本**，这是另外一个独立的机制。

对于 Git 性质的工作目录而言，Git 本身也是一个超强的历史版本工具，只要及时提交 (commit)，是不用太担心数据丢失的问题，当然，也建议另外基于 Git 日常再备份的习惯。
而对于外部工作目录而言，维护、备份、同步数据的机制在外部，也不是 Metion 可以控制的，所以不做另外说明。
如果是基于 iCloud云盘 的，可能会遇到**数据丢失**的困惑，除了误操作之外，也可能是 iCloud云盘 本身的机制会让使用者产生一些误判。下面，我们会另外介绍 Metion 的一些存储的逻辑作为补充。

首先，Metion 在 iCloud云盘 上的工作目录中，采取**双向存储**的机制，先本地设备存储一份再存储一份到 iCloud云盘 上。对于 Metion 而言，就是一个文件分别存储到两个文件夹里，只是其中一个文件夹位于 iCloud 而已，而后续的如何同步，Metion 则完全不参与。如果这个时候，iCloud云盘 工作不流畅，甚至失效，你就会感觉到同步也会出问题。
有些`文档丢失`，就是数据没有及时同步导致的，它实际上没有丢失，只是存储在 iCloud 的服务器上，但是还没有同步到本地设备、或者正在等待同步到本地设备中。根据实际经验来看，特别在当前设备容量不足时，iCloud云盘 会很容易触发一种自动清理的逻辑(相当于本地设备删除文件但保留一个不占容量的同名链接)。由于 Metion 在不断迭代过程中，增加了**双向存储**的对应机制，这个情况基本上不会发生，但是在跨设备同步的时候，它仍然是客观存在着的。

Metion 的每个文档保存时，都会尝试保存一个历史版本 (滚动自动删除)，小文件总数不超过 150 份，大文件的版本总数不超过 20 份，版本间隔为 1 分钟；另外也有一个独立的预防性逻辑 (外部挂载的目录不支持)，叫**最近文档的历史版本**，每个文档最多对应 15 个版本，版本最小间隔为 20秒，该功能的版本总数不超过 300 份。
**注意: 历史版本的机制是本地存储，不参与同步的，在 A 设备上产生的版本数据只能在 A 设备上找，在 B 设备上是找不到的。**

另外，下面一些的信息，或许会对你有所帮助:
1. 文档列表的某篇文档向左滑动或者右键点击，可以看到当前文档的**历史版本**入口;
2. 在**设置界面**中有**回收站**的入口;
3. 在 iCloud云盘 上的 Metion 目录中，有一个 **__Trashbox** 目录，里面存储了一些其它设备标记删除的文件;
4. 上面提到的**历史版本**只存储于当前设备中，不参与同步，实际存储于文档所在父目录下的一个隐藏文件夹，叫 `.Archive`;
5. 使用 Files(系统内置 App)，打开本地 Metion 的数据目录(位于`我的iPhone`或`我的iPad`)，其中**Storage**是存储所有工作目录的，而**Trash**则是`回收站`(也会定期清理)的数据存储目录，在 macOS 上也是类似的逻辑;
6. 除了使用者主动的操作，Metion 绝对不会主动删除文档，而在一些同步逻辑中不可避免的操作，也尽可能做好额外对应，比如: 产生的文档内容覆盖会尽可能存一份**历史版本**，如果是删除的操作，也会尽可能移到回收站的逻辑中;
7. 另外，当操作系统 (iOS/iPadOS/macOS) 提示、警告使用者某些操作(比如禁用 iCloud云盘、直接删除某个 App)会导致数据的删除，那么它就一定会删除且基本无法找回，请务必慎重再慎重，想清楚再操作，如有需要，先做好备份！
